<html>

<head>
  <title>Test Runner</title>
</head>

<body>
  <div class="outer-container">
    <web-component-shadow></web-component-shadow>
    <web-component-no-shadow>
      <div class="wc-noshadow-container">
        <button class="button no-shadow" id="no-shadow-button">Button</button>
      </div>
    </web-component-no-shadow>
  </div>

  <script>
    window.hlx = {
      rum: {
        calls: [],
        reset() {
          window.hlx.rum.calls = [];
        },
        sampleRUM(...args) {
          window.hlx.rum.calls.push(args);
        }
      }
    }
  </script>

  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { expect } from '@esm-bundle/chai';
    import '../../modules/index.js';
    import { sendMouse } from '@web/test-runner-commands';

    class WebComponentShadow extends HTMLElement {
      constructor() {
        super();
        const shadow = this.attachShadow({ mode: 'open' });
        const container = document.createElement('div');
        container.className = 'wc-shadow-container';

        const btn = document.createElement('button');
        btn.className = 'button shadow';
        btn.id = 'shadow-button';
        btn.innerText = 'Shadow Button';
        container.appendChild(btn);
        shadow.appendChild(container);
      }
    }
    customElements.define('web-component-shadow', WebComponentShadow);

    class WebComponentNoShadow extends HTMLElement { }
    customElements.define('web-component-no-shadow', WebComponentNoShadow);

    // wait for plugins to load
    await new Promise((resolve) => setTimeout(resolve, 1000));

    function testElementClick(element) {
      // find bounding box, click it, return promise that resolves when the click is sampled
      return new Promise((resolve) => {
        const before = window.hlx.rum.calls.length;
        let interval;
        interval = setInterval(() => {
          if (window.hlx.rum.calls.length > before) {
            clearInterval(interval);
            const selector = window.hlx.rum.calls[window.hlx.rum.calls.length - 1][1].source;
            resolve({ selector, calls: window.hlx.rum.calls });
          }
        }, 10);

        const pos = element.getBoundingClientRect();
        sendMouse({
          type: 'click', position: [
            Math.round(pos.x + (pos.width / 2)),
            Math.round(pos.y + (pos.height / 2))
          ]
        }).catch(console.error);
      });
    }

    runTests(async () => {
      describe('dom#sourceSelector', () => {
        it('webcomponent - no shadow root', async () => {
          const element = document.querySelector('web-component-no-shadow');
          const button = element.querySelector('button');
          const { selector, calls } = await testElementClick(button);
          expect(selector).to.equal('button#no-shadow-button'); // finds the button
          // only 1 click event
          expect(calls.filter((call) => call[0] === 'click').length).to.equal(1);
        });

        it('webcomponent - shadow root', async () => {
          const element = document.querySelector('web-component-shadow');
          const button = element.shadowRoot.querySelector('button');
          const { selector, calls } = await testElementClick(button);
          expect(selector).to.equal('button#shadow-button'); // also finds the button
          // only 1 click event
          expect(calls.filter((call) => call[0] === 'click').length).to.equal(1);
        });
      });

      afterEach(() => {
        window.hlx.rum.reset();
      });

      after(() => {
        window.hlx = undefined;
      });
    });
  </script>
</body>

</html>