<html>
<head>
  <title>A11y - Focus Loss Noise Test (Form Navigation)</title>
  <script>
    window.RUM_BASE = window.origin;
    window.hlx = {
      RUM_MASK_URL: 'origin',
      A11Y_REPORT_DELAY: 1000,
    };
    window.events = [];
    window.fakeSendBeacon = function (url, payload) {
      if (typeof payload === 'string') {
        window.events.push(JSON.parse(payload));
      } else {
        payload.text().then((text) => {
          window.events.push(JSON.parse(text));
        });
      }
    };
  </script>
  <script defer type="text/javascript" src="/.rum/@adobe/helix-rum-js@^2/dist/rum-standalone.js"></script>
</head>
<body>
  <form id="test-form">
    <label for="first">First</label>
    <input id="first" type="text" />
    <label for="second">Second</label>
    <input id="second" type="text" />
    <label for="third">Third</label>
    <input id="third" type="text" />
  </form>

  <script type="module">
    import { runTests } from '@web/test-runner-mocha';
    import { sendKeys } from '@web/test-runner-commands';
    import { expect } from '@esm-bundle/chai';
    import { pollForError } from './a11y.test.utils.js';

    const wait = (ms) => new Promise((r) => setTimeout(r, ms));

    runTests(async () => {
      describe('A11y Focus-Loss - No false positives on form field navigation', () => {
        it('does not report focus-loss when tabbing between inputs', async () => {
          // Ensure focus starts on the first input
          const first = document.getElementById('first');
          const second = document.getElementById('second');
          const third = document.getElementById('third');

          first.focus();
          await wait(50);

          // Tabbing between inputs should NOT cause focus-loss
          await sendKeys({ press: 'Tab' });
          await wait(50);
          expect(document.activeElement).to.equal(second);

          await sendKeys({ press: 'Tab' });
          await wait(50);
          expect(document.activeElement).to.equal(third);

          // Give a small grace period for any potential erroneous reporting
          const err = await pollForError('focus-loss', 500);
          expect(err).to.not.exist;
        });
      });
    });
  </script>
</body>
</html>


