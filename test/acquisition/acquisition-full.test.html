<html>

<head>
  <title>Test Runner</title>
</head>

<body>
<script type="module">
  import { runTests } from '@web/test-runner-mocha';
  import { expect } from '@esm-bundle/chai';

  runTests(async () => {
    describe('Acquisition checkpoint with params', () => {

      const setQueryParams = ( params ) => {
        const url = new URL(window.location.href);
        url.searchParams.delete('wtr-session-id');
        Object.entries(params).forEach(([key, value]) => {
          url.searchParams.set(key, value);
        })
        history.replaceState(null, '', url.href);
      }

      it('with referrer and query params', async () => {
        setQueryParams({
          utm_id: 'some-pii-utm-id',
          utm_medium: 'some-utm-medium',
          utm_source: 'some-utm-source',
          gclid: 'some-google-id',
          not_interesting_param: 'some-value'
        })
        Object.defineProperty(document, 'referrer', {
          value: 'https://some-referrer.com/',
          configurable: true
        });

        let acquisition;

        window.hlx = { rum: {} };
        window.hlx.rum.sampleRUM = (checkpoint, data) => {
          if (checkpoint === 'acquisition') {
            acquisition = data;
          }
        }
        window.hlx.rum.sampleRUM.drain = () => {};

        const script = document.createElement('script');
        script.src = new URL('/src/index.js', window.location).href;
        document.head.appendChild(script);

        await new Promise((resolve) => {
          script.onload = resolve;
        });

        const expectedAcquisition = {
          source: 'https://some-referrer.com/',
          target: '{"utm_source":"some-utm-source","utm_medium":"some-utm-medium","others":["gclid","not_interesting_param"]}'
        }

        expect(acquisition).to.eql(expectedAcquisition);
      });
    });
  });
</script>
</body>

</html>
